#
#--------------------------シークレットのメタデータを保存-----------------------------------#
#
resource "aws_secretsmanager_secret" "sops-test-secretsmanager" {
  description = "sops/test/secrets"
  kms_key_id  = "arn:aws:kms:ap-northeast-1:267751904634:key/7c3ecd1f-9a4b-45ff-b764-46bd2cacef6a"
  name        = "sops/test/secrets"
  force_overwrite_replica_secret = false
  recovery_window_in_days        = 30
}

#
#---------------------------バージョン、キーバリューリソース-----------------------------------#
#

variable "secret" {
  default = {
    DB_USERNAME = "postgres"
    DB_PASSWORD = "8:o~GuQcrTOwGb_-"
    DB_PORT = "5432"
    SECRET_KEY = "eof8d+hk0p5qyl4x4t9u5$@fal%k!d$y+_0z7_#d@lyu_3xcc4"
  }

  type = map(string)
}


resource "aws_secretsmanager_secret_version" "sops-test-secretsmanager-version" {
  secret_id     = aws_secretsmanager_secret.sops-test-secretsmanager.id
  secret_string = jsonencode({"DB_HOST" = data.sops_file.secrets.data["DB_HOST"], "DB_NAME" = data.sops_file.secrets.data["DB_NAME"]})
}